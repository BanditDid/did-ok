<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DID Remote</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Prompt:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body class="remote-page-v2">
    <!-- Top Brand Bar -->
    <div class="remote-brand-bar">
        <div class="brand-info">
            <div class="brand-logo">üé§ <span>Karaoke Remote</span></div>
            <div class="room-info" id="room-display">‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á: -</div>
        </div>
        <div class="brand-actions">
            <button class="btn-share-icon" onclick="refreshSync()" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                    <path d="M21 3v5h-5"></path>
                </svg>
            </button>
            <button class="btn-share-icon" onclick="toggleFullscreen()" title="‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠">
                <svg id="fullscreen-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    width="20" height="20">
                    <path
                        d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">
                    </path>
                </svg>
            </button>
        </div>
    </div>

    <div class="remote-main-content">
        <!-- Title & Status -->
        <div class="remote-title-section">
            <p class="user-display" onclick="showNameModal()" style="cursor: pointer;">
                ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <span id="user-name-display">-</span> ‚úèÔ∏è
            </p>
            <div class="connection-status-row">
                <div class="connection-badge">
                    <span class="dot"></span>
                    <span>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
                <button class="btn-share-small" onclick="openShareModal()" title="‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏µ‡πÇ‡∏°‡∏ó">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                        <polyline points="16,6 12,2 8,6"></polyline>
                        <line x1="12" y1="2" x2="12" y2="15"></line>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Now Playing Card -->
        <div class="np-card-v2">
            <div class="np-card-header">
                <div id="np-thumb-container" class="np-thumb-container">
                    <img id="np-thumb"
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80'%3E%3Crect fill='%231a1a2e' width='80' height='80'/%3E%3Ccircle cx='40' cy='40' r='25' fill='none' stroke='%23ff3c3c' stroke-width='2' opacity='0.5'/%3E%3Cpath d='M35 30v20l15-10z' fill='%23ff3c3c' opacity='0.6'/%3E%3C/svg%3E"
                        class="np-thumb-v2 empty-state">
                </div>
                <div class="np-meta empty-state">
                    <h3 id="np-title">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß</h3>
                    <p id="np-artist">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô üéµ</p>
                </div>
            </div>
            <div class="np-progress-v2">
                <span id="np-current-time" class="time-label">0:00</span>
                <div class="progress-track">
                    <div id="np-progress-fill" class="progress-fill-v2"></div>
                </div>
                <span id="np-total-time" class="time-label">0:00</span>
            </div>
            <div class="np-controls">
                <button id="remote-play-pause" class="btn-play-main">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
                        <path d="M8 5v14l11-7z" id="play-icon-path" />
                    </svg>
                </button>
                <button id="remote-skip" class="btn-skip" onclick="confirmSkipSong()">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22">
                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Volume Section -->
        <div class="volume-section-v2">
            <p class="section-title">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p>
            <div class="volume-row">
                <svg viewBox="0 0 24 24" fill="rgba(255,255,255,0.6)" width="20" height="20">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z" />
                </svg>
                <input type="range" id="remote-volume" min="0" max="100" value="100">
                <span id="volume-value" class="volume-number">100</span>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section-v2">
            <div class="search-header">
                <p class="section-title">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏•‡∏á</p>
                <label class="toggle-compact">
                    <span>‡∏Ñ‡πâ‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞</span>
                    <input type="checkbox" id="remote-karaoke-filter-toggle" checked>
                    <span class="toggle-dot"></span>
                </label>
            </div>
            <div class="search-box-v2">
                <input type="text" id="remote-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏•‡∏á..." enterkeyhint="search"
                    autocomplete="off">
                <button class="btn-clear-search" id="clear-remote-search-btn" onclick="clearRemoteSearchInput()"
                    style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16"
                        height="16">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div id="remote-results-overlay" class="results-overlay-v2">
                <div class="results-header" id="results-header">
                    <span class="results-title">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (<span id="results-count">0</span>)</span>
                    <button class="btn-toggle-results" onclick="toggleSearchResults()" title="‡∏¢‡∏∏‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢">
                        <svg id="toggle-results-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" width="18" height="18">
                            <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                    </button>
                </div>
                <div id="remote-results-list" class="results-list-v2"></div>
            </div>
        </div>

        <!-- Queue Section -->
        <div class="queue-section-v2">
            <div class="queue-header">
                <p class="section-title">‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏•‡∏á (<span id="queue-count-text">0</span>)</p>
                <!-- <button class="btn-clear-queue" onclick="clearQueueRemote()">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß</button> -->
            </div>
            <div id="remote-queue-list" class="queue-list-v2">
                <!-- Queue items -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Share Modal -->
    <div id="share-modal" class="search-modal">
        <div class="modal-content share-modal-premium">
            <div class="share-modal-header">
                <h3>üé§ ‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏µ‡πÇ‡∏°‡∏ó</h3>
                <button class="btn-close-share" onclick="closeShareModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <p class="share-hint">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞!</p>

            <div class="qr-container-premium">
                <div class="qr-wrapper">
                    <div id="share-qrcode"></div>
                </div>
                <div class="room-badge-large">‡∏´‡πâ‡∏≠‡∏á: <span id="share-room-id">------</span></div>
            </div>

            <div class="share-link-section">
                <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</label>
                <div class="share-link-row">
                    <input type="text" id="share-link-input" readonly value="">
                    <button class="btn-copy-premium" onclick="copyShareLink()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18"
                            height="18">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                    </button>
                </div>
            </div>

            <button class="btn-close-full" onclick="closeShareModal()">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <!-- Name Input Modal -->
    <div id="name-modal" class="name-modal">
        <div class="name-modal-content">
            <div class="name-modal-icon">üé§</div>
            <h3>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!</h3>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Remote</p>
            <input type="text" id="user-name-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." maxlength="20">
            <button id="confirm-name-btn" class="btn-confirm-name">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="confirm-modal">
        <div class="confirm-modal-content">
            <div class="confirm-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" width="48" height="48">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
            </div>
            <h3 id="confirm-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
            <p id="confirm-message">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="confirm-buttons">
                <button class="btn-confirm-cancel" onclick="closeConfirmModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn-confirm-ok" id="confirm-ok-btn">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');

        // Display room ID in the top bar
        if (roomId) {
            const roomDisplay = document.getElementById('room-display');
            if (roomDisplay) roomDisplay.innerText = '‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á: ' + roomId;
        }

        let isPlaying = false;
        let userName = localStorage.getItem('remoteUserName') || '';
        let shareQRGenerated = false;
        let currentQueueRemote = [];

        // Fullscreen Functions
        function toggleFullscreen() {
            const doc = window.document;
            const docEl = doc.documentElement;
            const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
            const cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;
            const icon = document.getElementById('fullscreen-icon');

            if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
                if (requestFullScreen) requestFullScreen.call(docEl);
                if (icon) icon.innerHTML = '<path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>';
            } else {
                if (cancelFullScreen) cancelFullScreen.call(doc);
                if (icon) icon.innerHTML = '<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>';
            }
        }

        // Auto fullscreen on mobile (requires user interaction)
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Refresh sync function - request data sync from server
        function refreshSync() {
            if (roomId) {
                socket.emit('request-sync', roomId);
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            }
        }

        // Listen for fullscreen changes to update icon
        document.addEventListener('fullscreenchange', () => {
            const icon = document.getElementById('fullscreen-icon');
            if (document.fullscreenElement) {
                if (icon) icon.innerHTML = '<path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>';
            } else {
                if (icon) icon.innerHTML = '<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>';
            }
        });

        // Share Modal Functions
        function openShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.add('active');

            // Generate QR code if not already done
            if (!shareQRGenerated && roomId) {
                const remoteUrl = `${window.location.origin}/remote.html?room=${roomId}`;
                const qrContainer = document.getElementById('share-qrcode');
                qrContainer.innerHTML = '';
                // Adjust QR size based on screen height
                const qrSize = window.innerHeight < 700 ? 180 : 220;
                new QRCode(qrContainer, {
                    text: remoteUrl,
                    width: qrSize,
                    height: qrSize,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.M
                });

                document.getElementById('share-room-id').innerText = roomId;
                document.getElementById('share-link-input').value = remoteUrl;
                shareQRGenerated = true;
            }
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
        }

        function copyShareLink() {
            const linkInput = document.getElementById('share-link-input');
            linkInput.select();
            document.execCommand('copy');
            showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß!');
        }

        // Show name modal
        function showNameModal() {
            const input = document.getElementById('user-name-input');
            if (userName) {
                input.value = userName;
            }
            document.getElementById('name-modal').classList.add('active');
            input.focus();
            input.select();
        }

        function confirmName() {
            const nameInput = document.getElementById('user-name-input');
            const name = nameInput.value.trim();
            if (name.length < 1) {
                nameInput.style.borderColor = '#ff4d4d';
                nameInput.placeholder = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠!';
                return;
            }
            userName = name;
            localStorage.setItem('remoteUserName', userName);
            document.getElementById('name-modal').classList.remove('active');
            document.getElementById('user-name-display').innerText = userName;

            // Now join the room
            if (roomId) {
                socket.emit('join-room', roomId);
            }
        }

        // Confirm Modal Functions
        let confirmCallback = null;

        function showConfirmModal(title, message, callback) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-message').innerText = message;
            confirmCallback = callback;
            document.getElementById('confirm-modal').classList.add('active');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('active');
            confirmCallback = null;
        }

        document.getElementById('confirm-ok-btn').onclick = () => {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        };

        // Skip song with confirmation
        function confirmSkipSong() {
            if (currentQueueRemote.length === 0) {
                showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß');
                return;
            }
            showConfirmModal(
                '‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏•‡∏á',
                '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                () => {
                    socket.emit('skip-song', roomId);
                }
            );
        }

        // Display username on load
        if (userName) {
            document.getElementById('user-name-display').innerText = userName;
        }

        document.getElementById('confirm-name-btn').onclick = confirmName;
        document.getElementById('user-name-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') confirmName();
        });

        // Check if name exists, if not show modal, else join room
        if (roomId) {
            if (!userName) {
                showNameModal();
            } else {
                socket.emit('join-room', roomId);
            }
        } else {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        }

        // Permissions state
        let remotePermissions = {
            autoSearch: false,
            addToQueue: true,
            removeFromQueue: true,
            playFromQueue: true,
            playPause: true,
            volume: true,
            shareRemote: true,
            editRemoteName: true
        };

        // Apply permissions to UI
        function applyPermissions() {
            console.log('Applying permissions:', remotePermissions);

            // Play/Pause button (using ID)
            const playPauseBtn = document.getElementById('remote-play-pause');
            if (playPauseBtn) {
                playPauseBtn.classList.toggle('remote-control-disabled', !remotePermissions.playPause);
                playPauseBtn.disabled = !remotePermissions.playPause;
            }

            // Skip button
            const skipBtn = document.getElementById('remote-skip');
            if (skipBtn) {
                skipBtn.classList.toggle('remote-control-disabled', !remotePermissions.playPause);
                skipBtn.disabled = !remotePermissions.playPause;
            }

            // Volume section (correct class name)
            const volumeSection = document.querySelector('.volume-section-v2');
            if (volumeSection) {
                volumeSection.classList.toggle('remote-control-disabled', !remotePermissions.volume);
                const volumeInput = document.getElementById('remote-volume');
                if (volumeInput) volumeInput.disabled = !remotePermissions.volume;
            }

            // Share button - find by onclick function
            const shareBtn = document.querySelector('[onclick="openShareModal()"]');
            if (shareBtn) {
                shareBtn.classList.toggle('remote-control-disabled', !remotePermissions.shareRemote);
            }

            // Edit name - the user display section
            const userDisplay = document.querySelector('.user-display');
            if (userDisplay) {
                userDisplay.classList.toggle('remote-control-disabled', !remotePermissions.editRemoteName);
                userDisplay.style.pointerEvents = remotePermissions.editRemoteName ? 'auto' : 'none';
            }

            // Re-render queue to update play/remove buttons
            if (currentQueueRemote && currentQueueRemote.length > 0) {
                updateQueueUI(currentQueueRemote);
            }

            // Update add buttons in visible search results
            document.querySelectorAll('.btn-add-remote').forEach(btn => {
                if (!remotePermissions.addToQueue) {
                    btn.classList.add('remote-control-disabled');
                    btn.disabled = true;
                } else {
                    btn.classList.remove('remote-control-disabled');
                    btn.disabled = false;
                }
            });
        }

        // Handle initial sync when joining room
        socket.on('room-joined', ({ queue, currentSong, permissions }) => {
            console.log('Room joined, syncing initial data...');
            if (permissions) {
                remotePermissions = { ...remotePermissions, ...permissions };
                applyPermissions();
            }
            updateQueueUI(queue);
            updateNowPlaying(currentSong);
        });

        // Handle full sync response
        socket.on('full-sync', ({ queue, currentSong, permissions }) => {
            console.log('Full sync received');
            if (permissions) {
                remotePermissions = { ...remotePermissions, ...permissions };
                applyPermissions();
            }
            updateQueueUI(queue);
            updateNowPlaying(currentSong);
        });

        // Handle permissions updates from host
        socket.on('permissions-updated', (permissions) => {
            console.log('Permissions updated:', permissions);
            remotePermissions = { ...remotePermissions, ...permissions };
            applyPermissions();
        });

        // Handle song error notifications
        socket.on('song-error', ({ songTitle, reason }) => {
            console.log('Song error:', songTitle, reason);
            showErrorToast(`‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${songTitle.substring(0, 30)}...`, reason);
        });

        // Periodic sync every 5 seconds to ensure data consistency
        setInterval(() => {
            if (roomId) {
                socket.emit('request-sync', roomId);
            }
        }, 5000);

        // Helper function to update now playing display
        function updateNowPlaying(song) {
            const title = document.getElementById('np-title');
            const artist = document.getElementById('np-artist');
            const thumb = document.getElementById('np-thumb');
            const meta = thumb.closest('.np-card-header').querySelector('.np-meta');

            if (song) {
                title.innerText = song.title;
                artist.innerText = song.author;
                thumb.src = song.thumbnail;
                thumb.classList.remove('empty-state');
                if (meta) meta.classList.remove('empty-state');
            } else {
                title.innerText = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß";
                artist.innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô üéµ";
                thumb.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80'%3E%3Crect fill='%231a1a2e' width='80' height='80'/%3E%3Ccircle cx='40' cy='40' r='25' fill='none' stroke='%23ff3c3c' stroke-width='2' opacity='0.5'/%3E%3Cpath d='M35 30v20l15-10z' fill='%23ff3c3c' opacity='0.6'/%3E%3C/svg%3E";
                thumb.classList.add('empty-state');
                if (meta) meta.classList.add('empty-state');
            }
        }

        // Helper function to update queue UI
        function updateQueueUI(queue) {
            currentQueueRemote = queue;
            const queueList = document.getElementById('remote-queue-list');
            const queueCount = document.getElementById('queue-count-text');
            queueCount.innerText = queue.length;
            queueList.innerHTML = '';

            const playDisabled = !remotePermissions.playFromQueue;
            const removeDisabled = !remotePermissions.removeFromQueue;

            queue.forEach((song, index) => {
                const card = document.createElement('div');
                card.className = 'queue-item-v2';
                card.innerHTML = `
                    <span class="qi-num">${index + 1}</span>
                    <img src="${song.thumbnail}" class="qi-thumb-v2">
                    <div class="qi-meta">
                        <h4>${song.title}</h4>
                        <p>${song.author}</p>
                        ${song.addedBy ? `<span class="qi-by">${song.addedBy}</span>` : ''}
                    </div>
                    <div class="qi-btns">
                        <button class="qi-play${playDisabled ? ' remote-control-disabled' : ''}" onclick="playSpecificRemote(${index})" ${playDisabled ? 'disabled' : ''}>‚ñ∂</button>
                        <button class="qi-del${removeDisabled ? ' remote-control-disabled' : ''}" onclick="removeSpecificRemote(${index})" ${removeDisabled ? 'disabled' : ''}>‚úï</button>
                    </div>
                `;
                queueList.appendChild(card);
            });
        }

        // Search Logic
        let searchTimeout;
        let currentSearchQuery = '';
        let currentSearchPage = 1;
        let isResultsCollapsed = false;
        const searchInput = document.getElementById('remote-search-input');
        const clearRemoteSearchBtnEl = document.getElementById('clear-remote-search-btn');
        const resultsOverlay = document.getElementById('remote-results-overlay');
        const resultsList = document.getElementById('remote-results-list');

        // Toggle search results collapse/expand
        function toggleSearchResults() {
            isResultsCollapsed = !isResultsCollapsed;
            const resultsList = document.getElementById('remote-results-list');
            const icon = document.getElementById('toggle-results-icon');

            if (isResultsCollapsed) {
                resultsList.style.display = 'none';
                icon.innerHTML = '<polyline points="6 9 12 15 18 9"></polyline>';
            } else {
                resultsList.style.display = 'block';
                icon.innerHTML = '<polyline points="18 15 12 9 6 15"></polyline>';
            }
        }

        function clearRemoteSearchInput() {
            searchInput.value = '';
            clearRemoteSearchBtnEl.style.display = 'none';
            resultsOverlay.classList.remove('active');
            searchInput.focus();
        }

        // Toggle switch listener - re-search without focusing input
        document.getElementById('remote-karaoke-filter-toggle').addEventListener('change', async () => {
            const query = searchInput.value.trim();
            if (query.length >= 2) {
                resultsOverlay.classList.add('active');
                resultsList.innerHTML = `
                    <div class="search-loading">
                        <div class="search-loading-notes">
                            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                        </div>
                        <div class="search-loading-spinner"></div>
                        <div class="search-loading-text">
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            <div class="search-loading-dots">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    </div>
                `;
                currentSearchQuery = query;
                currentSearchPage = 1;
                try {
                    const karaokeOnly = document.getElementById('remote-karaoke-filter-toggle').checked;
                    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&page=1&karaokeOnly=${karaokeOnly}`);
                    const songs = await res.json();
                    displaySearchCard(songs, false);
                } catch (err) {
                    resultsList.innerHTML = '<div class="error">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>';
                }
            }
        });

        // Handle Enter/Search key on mobile - trigger search and hide keyboard
        searchInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchInput.blur(); // Hide keyboard on mobile

                const query = searchInput.value.trim();
                if (query.length >= 1) {
                    clearTimeout(searchTimeout);
                    resultsOverlay.classList.add('active');
                    resultsList.innerHTML = `
                        <div class="search-loading">
                            <div class="search-loading-notes">
                                <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                                <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                                <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                            </div>
                            <div class="search-loading-spinner"></div>
                            <div class="search-loading-text">
                                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                                <div class="search-loading-dots">
                                    <span></span><span></span><span></span>
                                </div>
                            </div>
                        </div>
                    `;
                    currentSearchQuery = query;
                    currentSearchPage = 1;
                    try {
                        const karaokeOnly = document.getElementById('remote-karaoke-filter-toggle').checked;
                        const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&page=1&karaokeOnly=${karaokeOnly}`);
                        const songs = await res.json();
                        displaySearchCard(songs, false);
                    } catch (err) {
                        resultsList.innerHTML = '<div class="error">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>';
                    }
                }
            }
        });

        searchInput.addEventListener('input', () => {
            clearRemoteSearchBtnEl.style.display = searchInput.value.length > 0 ? 'flex' : 'none';
            clearTimeout(searchTimeout);
            const query = searchInput.value;
            if (query.length < 2) {
                resultsOverlay.classList.remove('active');
                return;
            }

            searchTimeout = setTimeout(async () => {
                resultsOverlay.classList.add('active');
                resultsList.innerHTML = `
                    <div class="search-loading">
                        <div class="search-loading-notes">
                            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                        </div>
                        <div class="search-loading-spinner"></div>
                        <div class="search-loading-text">
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            <div class="search-loading-dots">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    </div>
                `;
                currentSearchQuery = query;
                currentSearchPage = 1;
                try {
                    const karaokeOnly = document.getElementById('remote-karaoke-filter-toggle').checked;
                    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&page=1&karaokeOnly=${karaokeOnly}`);
                    const songs = await res.json();
                    displaySearchCard(songs, false);
                } catch (err) {
                    resultsList.innerHTML = '<div class="error">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>';
                }
            }, 500);
        });

        async function loadMoreSearch() {
            currentSearchPage++;
            const loadMoreBtn = document.querySelector('.btn-load-more-remote');
            if (loadMoreBtn) loadMoreBtn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

            try {
                const karaokeOnly = document.getElementById('remote-karaoke-filter-toggle').checked;
                const res = await fetch(`/api/search?q=${encodeURIComponent(currentSearchQuery)}&page=${currentSearchPage}&karaokeOnly=${karaokeOnly}`);
                const songs = await res.json();
                displaySearchCard(songs, true);
            } catch (err) {
                console.error("Load more failed", err);
            }
        }

        function displaySearchCard(songs, append = false) {
            if (!append) resultsList.innerHTML = '';

            // Remove existing load more button if any
            const oldBtn = document.querySelector('.btn-load-more-remote');
            if (oldBtn) oldBtn.remove();

            // Update results count
            const existingCount = append ? resultsList.querySelectorAll('.remote-song-card').length : 0;
            const totalCount = existingCount + songs.length;
            document.getElementById('results-count').innerText = totalCount;

            if (!append && songs.length === 0) {
                resultsList.innerHTML = '<div class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏û‡∏•‡∏á</div>';
                document.getElementById('results-count').innerText = '0';
                return;
            }

            songs.forEach(song => {
                const card = document.createElement('div');
                card.className = 'remote-song-card';
                const addDisabled = !remotePermissions.addToQueue;
                card.innerHTML = `
                    <img src="${song.thumbnail}" class="rs-thumb">
                    <div class="rs-info">
                        <h4>${song.title}</h4>
                        <p>${song.author}</p>
                    </div>
                    <button class="btn-add-remote${addDisabled ? ' remote-control-disabled' : ''}" ${addDisabled ? 'disabled' : ''}>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                `;
                card.querySelector('.btn-add-remote').onclick = (e) => {
                    const btn = e.currentTarget;
                    const originalText = btn.innerHTML;

                    // Add song with user name
                    const songWithUser = { ...song, addedBy: userName };
                    socket.emit('add-to-queue', { roomId, song: songWithUser });

                    // Button feedback
                    btn.innerHTML = '‚úì ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß';
                    btn.classList.add('added');
                    btn.disabled = true;

                    // Show toast
                    showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° "${song.title.substring(0, 30)}..." ‡∏•‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß`);

                    // Reset button after 1.5 seconds
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('added');
                        btn.disabled = false;
                    }, 2000);
                };
                resultsList.appendChild(card);
            });

            if (songs.length >= 5) {
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.className = 'btn-load-more-remote';
                loadMoreBtn.innerText = '‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
                loadMoreBtn.onclick = loadMoreSearch;
                resultsList.appendChild(loadMoreBtn);
            }
        }

        // Close results when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !resultsOverlay.contains(e.target)) {
                resultsOverlay.classList.remove('active');
            }
        });

        // Controls
        document.getElementById('remote-play-pause').onclick = () => {
            socket.emit('toggle-play', roomId);
        };

        // Skip is handled by onclick="confirmSkipSong()" in HTML

        const volRange = document.getElementById('remote-volume');
        const volVal = document.getElementById('volume-value');
        volRange.oninput = () => {
            volVal.innerText = volRange.value;
            socket.emit('set-volume', { roomId, volume: volRange.value });
        };

        function clearQueueRemote() {
            showConfirmModal(
                '‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏•‡∏á',
                '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                () => {
                    socket.emit('clear-queue', roomId);
                }
            );
        }

        // Socket Events - Real-time updates
        socket.on('queue-updated', (queue) => {
            updateQueueUI(queue);
        });

        window.playSpecificRemote = (index) => {
            socket.emit('play-specific', { roomId, index });
        };

        window.removeSpecificRemote = (index) => {
            socket.emit('remove-from-queue', { roomId, index });
        };

        socket.on('play-song', (song) => {
            updateNowPlaying(song);
        });

        // Sync with playback state from server
        socket.on('player-state', ({ isPlaying: playing, volume, currentTime, duration }) => {
            isPlaying = playing;
            const playBtn = document.getElementById('remote-play-pause');
            if (isPlaying) {
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            } else {
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32"><path d="M8 5v14l11-7z"/></svg>';
            }

            if (volume !== undefined) {
                volRange.value = volume;
                volVal.innerText = volume;
            }

            if (duration > 0) {
                const percent = (currentTime / duration) * 100;
                document.getElementById('np-progress-fill').style.width = percent + '%';
                document.getElementById('np-current-time').innerText = formatTime(currentTime);
                document.getElementById('np-total-time').innerText = formatTime(duration);
            }
        });

        function formatTime(s) {
            const min = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        // Toast notification function
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        // Error toast for song playback errors
        function showErrorToast(title, reason) {
            const toast = document.getElementById('toast');
            toast.innerHTML = `<strong style="color:#ff6b6b;">‚ö†Ô∏è ${title}</strong><br><small>${reason}</small>`;
            toast.classList.add('show', 'error');
            setTimeout(() => {
                toast.classList.remove('show', 'error');
            }, 4000);
        }
    </script>
</body>

</html>